breaks = 50,
main = colnames(mat)[i],
xlab="Intensity",
col="gray",
cex.main = 0.8)
par(mfrow=c(2,3))
for (i in 1:ncol(mat)) {
hist(mat[,i],
breaks = 50,
main = colnames(mat)[i],
xlab="Intensity",
col="gray",
cex.main = 0.8)
}
# RMA does three steps: background correction → quantile normalization → probe summarization.
norm.data <- rma(raw.data)
# Distribution of normalized probe intensities per CEL file (per array)
boxplot(norm.data, main="Normalized intensities",
col=c(rep("coral", 3), rep("grey", 3)),
las = 3,
cex.axis = 0.7)
par() <- old.par
par(old.par)
# Distribution of normalized probe intensities per CEL file (per array)
boxplot(norm.data, main="Normalized intensities",
col=c(rep("coral", 3), rep("grey", 3)),
las = 3,
cex.axis = 0.7)
mat.norm <- exprs(norm.data)
par(mfrow=c(2,3))
for (i in 1:ncol(mat.norm)) {
hist(mat[,i],
breaks = 100,
main = colnames(mat.norm)[i],
xlab="Intensity",
col="skyblue",
cex.main = 0.8)
}
log.data <- apply(raw.data, 2, log2)
par(old.par)
# matrix of normalized expression values
mat.norm <- exprs(norm.data)
pca <- prcomp(t(mat.norm), scale. = TRUE)
plot(pca$x[,1], pca$x[,2],
pch = 20,
col = c(rep("skyblue", 3), rep("gray", 3)),
xlab = "PC1",
ylab = "PC2",
main = "PCA of RMA-normalized data")
plot(pca$x[,1], pca$x[,2],
pch = 20,
col = c(rep("orange", 3), rep("gray", 3)),
xlab = "PC1",
ylab = "PC2",
main = "PCA of RMA-normalized data")
text(pca$x[,1], pca$x[,2], labels = colnames(norm.data), pos = 3, cex = 0.7)
plot(pca$x[,1], pca$x[,2],
pch = 21,
col = c(rep("orange", 3), rep("gray", 3)),
xlab = "PC1",
ylab = "PC2",
main = "PCA of RMA-normalized data")
plot(pca$x[,1], pca$x[,2],
pch = 22,
col = c(rep("orange", 3), rep("gray", 3)),
xlab = "PC1",
ylab = "PC2",
main = "PCA of RMA-normalized data")
text(pca$x[,1], pca$x[,2], labels = colnames(norm.data), pos = 3, cex = 0.6)
plot(pca$x[,1], pca$x[,2],
pch = 20,
col = c(rep("orange", 3), rep("gray", 3)),
xlab = "PC1",
ylab = "PC2",
main = "PCA of RMA-normalized data")
text(pca$x[,1], pca$x[,2], labels = colnames(norm.data), pos = 3, cex = 0.6)
text(pca$x[,1], pca$x[,2], labels = colnames(norm.data), pos = 2, cex = 0.6)
plot(pca$x[,1], pca$x[,2],
pch = 20,
col = c(rep("orange", 3), rep("gray", 3)),
xlab = "PC1",
ylab = "PC2",
main = "PCA of RMA-normalized data")
text(pca$x[,1], pca$x[,2], labels = colnames(norm.data), pos = 2, cex = 0.6)
plot(pca$x[,1], pca$x[,2],
pch = 20,
col = c(rep("orange", 3), rep("gray", 3)),
xlab = "PC1",
ylab = "PC2",
main = "PCA of RMA-normalized data")
text(pca$x[,1], pca$x[,2], labels = colnames(norm.data), pos = 1, cex = 0.6)
par(mar = c(5,5,5,10))
plot(pca$x[,1], pca$x[,2],
pch = 20,
col = c(rep("orange", 3), rep("gray", 3)),
xlab = "PC1",
ylab = "PC2",
main = "PCA of RMA-normalized data")
text(pca$x[,1], pca$x[,2], labels = colnames(norm.data), pos = 1, cex = 0.6)
plot(pca$x[,1], pca$x[,2],
pch = 20,
col = c(rep("orange", 3), rep("gray", 3)),
xlab = "PC1",
ylab = "PC2",
main = "PCA of RMA-normalized data")
par(old.par)
plot(pca$x[,1], pca$x[,2],
pch = 20,
col = c(rep("orange", 3), rep("gray", 3)),
xlab = "PC1",
ylab = "PC2",
main = "PCA of RMA-normalized data")
text(pca$x[,1], pca$x[,2],
labels = colnames(norm.data),
pos = 3, offset = 0.5, cex = 0.6)
plot(pca$x[,1], pca$x[,2],
pch = 20,
col = c(rep("orange", 3), rep("gray", 3)),
xlab = "PC1",
ylab = "PC2",
main = "PCA of RMA-normalized data".
plot(pca$x[,1], pca$x[,2],
pch = 20,
col = c(rep("orange", 3), rep("gray", 3)),
xlab = "PC1",
ylab = "PC2",
main = "PCA of RMA-normalized data",
bty = "n")
text(pca$x[,1], pca$x[,2],
labels = colnames(norm.data),
pos = 1, cex = 0.6)
plot(pca$x[,1], pca$x[,2],
pch = 20,
col = c(rep("orange", 3), rep("gray", 3)),
xlab = "PC1",
ylab = "PC2",
main = "PCA of RMA-normalized data",
bty = "n")
text(pca$x[,1], pca$x[,2],
labels = colnames(norm.data),
pos = 4, cex = 0.6)
par(xpd = TRUE)
plot(pca$x[,1], pca$x[,2],
pch = 20,
col = c(rep("orange", 3), rep("gray", 3)),
xlab = "PC1",
ylab = "PC2",
main = "PCA of RMA-normalized data",
bty = "n")
text(pca$x[,1], pca$x[,2],
labels = colnames(norm.data),
pos = 4, cex = 0.6)
par(xpd = FALSE)
short.names <- sub(".CEL$", "", colnames(norm.data))
short.names <- gsub("_tibia_female_", "_", short.names)
short.names <- gsub("weekold", "w", short.names)
short.names
group <- c(rep("Young", 3), rep("Old", 3))
cols <- c("orange", "gray")
as.factor(group)
cols[3]
cols[1]
cols[2]
plot(pca$x[,1], pca$x[,2],
pch = 19,
col = cols[as.factor(group)],
xlab = "PC1",
ylab = "PC2",
main = "PCA of RMA-normalized data")
legend("topright",
legend = c("Young", "Old"),
col = cols,
pch = 19,
bty = "n")
short.names
plot(pca$x[,1], pca$x[,2],
pch = 20,
col = c(rep("orange", 3), rep("gray", 3)),
xlab = "PC1",
ylab = "PC2",
main = "PCA of RMA-normalized data",
bty = "n")
text(pca$x[,1], pca$x[,2],
labels = colnames(norm.data),
pos = 4, cex = 0.6)
legend("topright",
legend = c("Young female", "Old female"),
col = c("orange", "gray"),
pch = 20)
legend("topright",
legend = c("Young female", "Old female"),
col = c("orange", "gray"),
pch = 20,
bty = "n")
plot(pca$x[,1], pca$x[,2],
pch = 20,
col = c(rep("orange", 3), rep("gray", 3)),
xlab = "PC1",
ylab = "PC2",
main = "PCA of RMA-normalized data",
bty = "n")
legend("topright",
legend = c("Young female", "Old female"),
col = c("orange", "gray"),
pch = 20,
bty = "n")
legend("topright",
legend = c("Young female", "Old female"),
col = c("orange", "gray"),
pch = 20,
bty = "n",
cex.main = 0.7)
plot(pca$x[,1], pca$x[,2],
pch = 20,
col = c(rep("orange", 3), rep("gray", 3)),
xlab = "PC1",
ylab = "PC2",
main = "PCA of RMA-normalized data",
bty = "n")
legend("topright",
legend = c("Young female", "Old female"),
col = c("orange", "gray"),
pch = 20,
bty = "n",
cex = 0.7)
plot(pca$x[,1], pca$x[,2],
pch = 20,
col = c(rep("orange", 3), rep("gray", 3)),
xlab = "PC1",
ylab = "PC2",
main = "PCA of RMA-normalized data",
bty = "n", cex.mai = 0.8)
plot(pca$x[,1], pca$x[,2],
pch = 20,
col = c(rep("orange", 3), rep("gray", 3)),
xlab = "PC1",
ylab = "PC2",
main = "PCA of RMA-normalized data",
bty = "n",
cex.main = 0.8)
legend("topright",
legend = c("Young female", "Old female"),
col = c("orange", "gray"),
pch = 20,
bty = "n",
cex = 0.8)
plot(pca$x[,1], pca$x[,2],
pch = 20,
col = c(rep("orange", 3), rep("gray", 3)),
xlab = "PC1",
ylab = "PC2",
main = "PCA of RMA-normalized data",
bty = "n",
cex.main = 0.8)
legend("topright",
legend = c("Young female", "Old female"),
col = c("orange", "gray"),
pch = 20,
bty = "n",
cex = 0.7)
View(norm.data)
View(mat.norm)
View(mat)
View(mat)
View(mat.norm)
View(mat)
View(mat.norm)
?dist
clusters <- hclust(dist(t(norm.data)))
clusters <- hclust(dist(t(mat.norm)))
plot(clusters)
# Perform hierarchical clustering
hc <- hclust(dist(t(mat.norm)))
plot(hc, main="Hierarchical Clustering of Samples",
xlab="", sub="", cex=0.8)
# Correlation-based distance (often better for expression data)
dist.mat <- as.dist(1 - cor(t(exprs(norm.data))))
hc <- hclust(dist.mat, method="complete")
plot(hc)
short.names <- sub(".CEL$", "", colnames(norm.data))
short.names <- gsub("tibia_female", "_", short.names)
short.names <- gsub("weekold", "w", short.names)
plot(pca$x[,1], pca$x[,2],
pch = 20,
col = c(rep("orange", 3), rep("gray", 3)),
xlab = "PC1",
ylab = "PC2",
main = "PCA of RMA-normalized data",
bty = "n",
cex.main = 0.8)
legend("topright",
legend = c("Young female", "Old female"),
col = c("orange", "gray"),
pch = 20,
bty = "n",
cex = 0.7)
text(pca$x[,1], pca$x[,2], labels = short.names, pos = 3, cex = 0.7)
# Perform hierarchical clustering
hc <- hclust(dist(t(mat.norm)))
plot(hc, main="Hierarchical Clustering of Samples",
xlab="", sub="", cex=0.8)
group <- factor(c(rep("Young", 3), rep("Old", 3)))
levels(group)
# Create a design matrix for old vs young
design <- model.matrix(~0 + group)
design
colnames(design) <- levels(group)
design
design <- model.matrix(~0 + group)
colnames(design) <- levels(group)
design
# Fit linear model with limma
fit <- lmFit(exprs(norm.data), design)
library(limma)
# Fit linear model with limma
fit <- lmFit(exprs(norm.data), design)
# Create a contrast (Old vs Young)
contrast.matrix <- makeContrasts(Old - Young, levels = design)
fit2 <- contrasts.fit(fit, contrast.matrix)
fit2 <- eBayes(fit2)
?topTable
results <- topTable(fit2, adjust.method = "BH", number = Inf)
head(results)
#Filter significant genes
sig <- results[results$adj.P.Val < 0.05 & abs(results$logFC) > 1, ]
dim(results)
dim8raw.data
dim(raw.data)
dim(sig)
#Filter significant genes
sig <- results[results$adj.P.Val < 0.05 && abs(results$logFC) > 1, ]
#Filter significant genes
sig <- results[results$adj.P.Val < 0.05 & abs(results$logFC) > 1, ]
#Filter significant genes
sig <- results[abs(results$logFC) > 1, ]
dim(sig)
#Filter significant genes
sig <- results[results$adj.P.Val < 0.05, ]
dim(sig)
#Filter significant genes
sig <- results[results$adj.P.Val < 0.1 & abs(results$logFC) > 1, ]
dim(sig)
order(results$P.Value)
topgenes <- results[order(results$P.Value), ][1:50, ]
topgenes
View(topgenes)
?order
sig <- results[results$P.Value < 0.1 & abs(results$logFC) > 1, ]
dim(sig) # 0 6
sig <- results[results$P.Value < 0.05 & abs(results$logFC) > 2, ]
dim(sig) # 0 6
sig <- results[results$P.Value < 0.05 & abs(results$logFC) > 1, ]
dim(sig) # 0 6
sig <- results[results$P.Value < 0.05 & abs(results$logFC) > 1.5, ]
dim(sig) # 0 6
sig <- results[results$P.Value < 0.01 & abs(results$logFC) > 1.5, ]
dim(sig) # 0 6
# Map probes to genes
annotation(raw.data)    #  "pd.clariom.s.mouse"
BiocManager::available(pattern="clariomsmouse")
# BiocManager::install("clariomsmousetranscriptcluster.db")
library(clariomsmousetranscriptcluster.db)
library(AnnotationDbi)
columns(clariomsmousetranscriptcluster.db)
results$GeneSymbol <- mapIds(clariomsmousetranscriptcluster.db,
keys=rownames(results),
column="SYMBOL",
keytype="PROBEID",
multiVals="first")
head(results)
results.annotated <- results[!is.na(results$GeneSymbol), ]
dim(results.annotated)
dim(results)
#Filter significant genes
sig <- results.annotated[
results.annotated$adj.P.Val < 0.05 & abs(results.annotated$logFC) > 1,
]
dim(sig) # 0 6
sig <- results.annotated[
results.annotated$P.Value < 0.05 & abs(results.annotated$logFC) > 1,
]
dim(sig)
sig <- results.annotated[
results.annotated$P.Value < 0.01 & abs(results.annotated$logFC) > 1.5,
]
dim(sig)
sig <- results.annotated[
results.annotated$P.Value < 0.05 & abs(results.annotated$logFC) > 1.5,
]
dim(sig) # 16  7
topgenes <- results.annotated[order(results.annotated$P.Value), ][1:20, ]
View(topgenes)
table(duplicated(results.annotated$GeneSymbol))
View(results.annotated)
View(results.annotated)
View(results)
View(results.annotated)
View(results)
library(dplyr)
results.genelevel <- results.annotated %>%
group_by(GeneSymbol) %>%           # group rows by gene symbol
slice_min(P.Value, n = 1)          # pick the row (probe) with the smallest p-value per gene
results.byGene <- results.annotated %>%
group_by(GeneSymbol) %>%           # group rows by gene symbol
slice_min(P.Value, n = 1)          # pick the row (probe) with the smallest p-value per gene
View(results.byGene)
results.annotated$ProbeID <- rownames(results.annotated)
results.byGene <- results.annotated %>%
group_by(GeneSymbol) %>%           # group rows by gene symbol
slice_min(P.Value, n = 1)          # pick the row (probe) with the smallest p-value per gene
View(results.byGene)
class(results.byGene)
results.byGene <- as.data.frame(results.byGene)
class(results.byGene)
rownames(results.byGene) <- results.byGene$ProbeID
View(results.byGene)
dim(results.byGene)
#Filter significant genes
sig <- results.byGene[
results.byGene$adj.P.Val < 0.05 & abs(results.byGene$logFC) > 1,
]
#Filter significant genes
sigs <- results.byGene[
results.byGene$adj.P.Val < 0.05 & abs(results.byGene$logFC) > 1,
]
dim(sigs) # 0 7
sigs <- results.byGene[
results.byGene$P.Value < 0.05 & abs(results.byGene$logFC) > 1.5,
]
dim(sigs) # 18  7
topgenes <- results.byGene[order(results.byGene$P.Value), ][1:20, ]
x <- results.byGene$logFC
y <- -log10(results.byGene$P.Val)
# Optional: highlight significant genes (FDR < 0.05)
sig <- results.byGene$P.Value < 0.05
sig
sig.genes <- results.byGene[
results.byGene$P.Value < 0.05 & abs(results.byGene$logFC) > 1.5,
]
dim(sig.genes) # 18  8
# Optional: highlight significant genes (FDR < 0.05)
sigs <- results.byGene$P.Value < 0.05 & abs(results.byGene$logFC) > 1.5
sigs
sum(results.byGene$P.Value < 0.05)
sum(results.byGene$P.Value < 0.05 & abs(results.byGene$logFC) > 1.5)
# volcano plot
plot(x, y,
pch=20,
col = "grey",
main="Old vs young females",
xlab="log2 Fold Change",
ylab="-log10(P-value)")
# Optional: highlight significant genes (FDR < 0.05)
sigs <- results.byGene$P.Value < 0.05 & abs(results.byGene$logFC) > 1.5
points(x[sigs], y[sigs], col="red", pch=20)
legend("bottomleft",
legend=c("Non-significant", "Significant (P.value < 0.05)"),
col=c("grey", "red"),
pch=20,
bty = "n",
y.intersp=0.7)
# Add a column to mark significance
results.byGene$Significant <- results.byGene$P.Value < 0.05 & abs(results.byGene$logFC) > 1.5
View(results.byGene)
library(ggrepel)
library(ggrepel)
library(ggplot2)
ggplot(results.byGene, aes(x=logFC, y=-log10(P.Value), color=Significant)) +
geom_point(alpha=0.6) +
scale_color_manual(values=c("grey", "red")) +
xlab("log2 Fold Change") +
ylab("-log10(P.Value)") +
ggtitle("Old vs Young females") +
geom_hline(yintercept=-log10(0.05), linetype="dashed", color="black") +
geom_vline(xintercept=c(-1,1), linetype="dashed", color="black") +
geom_text_repel(
data = results.byGene,
aes(x = logFC, y = -log10(P.Value), label = GeneSymbol),
inherit.aes = FALSE,
color = "forestgreen"
) +
theme_minimal()
ggplot(results.byGene, aes(x=logFC, y=-log10(P.Value), color=Significant)) +
geom_point(alpha=0.6) +
scale_color_manual(values=c("grey", "red")) +
xlab("log2 Fold Change") +
ylab("-log10(P.Value)") +
ggtitle("Old vs Young females") +
geom_hline(yintercept=-log10(0.05), linetype="dashed", color="black") +
geom_vline(xintercept=c(-1,1), linetype="dashed", color="black") +
geom_text_repel(
data = sig.genes,
aes(x = logFC, y = -log10(P.Value), label = GeneSymbol),
inherit.aes = FALSE,
color = "forestgreen"
) +
theme_minimal()
ggplot(results.byGene, aes(x=logFC, y=-log10(P.Value), color=Significant)) +
geom_point(alpha=0.6) +
scale_color_manual(values=c("grey", "red")) +
xlab("log2 Fold Change") +
ylab("-log10(P.Value)") +
ggtitle("Old vs Young females") +
geom_hline(yintercept=-log10(0.05), linetype="dashed", color="black") +
geom_vline(xintercept=c(-1,1), linetype="dashed", color="black") +
geom_text_repel(
data = subset(results.byGene, Significant),  # only significant genes
aes(x = logFC, y = -log10(P.Value), label = GeneSymbol),
color = "forestgreen",
size = 3
) +
theme_minimal()
